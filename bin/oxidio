#!/usr/bin/env php
<?php
/**
 * Copyright (C) oxidio. See LICENSE file for license details.
 */

namespace Oxidio;

use JsonSerializable;
use OxidEsales\Eshop\Core\{
    Module,
    Registry
};
use fn;
use Symfony\Component\Yaml\Yaml;
use Traversable;

call_user_func(static function () {
    $file = file_exists($file = __DIR__ . '/../../../autoload.php') ? $file : __DIR__ . '/../vendor/autoload.php';
    /** @noinspection PhpIncludeInspection */
    exit(call_user_func(require $file, static function () {
        $cli = fn\cli([
            'cli.name' => 'oxidio/oxidio',
            'cli.commands.default' => false,
            'write' => static function(fn\Cli\IO $io) {
                return static function($it, $format = 'yaml') use($io) {
                    $it instanceof Traversable || $it = fn\map([$it]);
                    foreach ($it as $line) {
                        $line = $line instanceof JsonSerializable ? $line->jsonSerialize() : $line;
                        if ($format === 'yaml') {
                            $line = Yaml::dump($line);
                        } else if ($format === 'json') {
                            json_encode($line, JSON_PRETTY_PRINT);
                        }
                        $io->writeln((string) $line);
                    }
                };
            }
        ]);

        $cli->command('modules', static function (callable $write) {
            $dir = Registry::getConfig()->getModulesDir();
            $write(fn\map(oxNew(Module\ModuleList::class)->getModulesFromDir($dir), static function(Module\Module $module) {
                return $module->getId();
            }));
        });

        $cli->command('shop', static function (callable $write, $property, $shop = null) {
            $write(shop($shop)->$property);
        }, ['property']);

        $cli->command('test:dml', require 'test-dml.php', ['action', 'name']);

        return $cli->run();
    }));
});
